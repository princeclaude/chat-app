<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Card Duel</title>
  <style>
    :root {
      --bg:#052a36; --panel:#083844; --accent:#7c3aed; --muted:rgba(255,255,255,0.6);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui;background:linear-gradient(180deg,var(--bg),#01292f);color:#fff}
    .wrap{max-width:980px;margin:28px auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .players{display:flex;gap:18px;align-items:center}
    .player{background:var(--panel);padding:10px 14px;border-radius:12px;min-width:160px;text-align:center}
    .pin{font-weight:700;font-size:18px}
    .status{font-size:13px;color:var(--muted);margin-top:6px}
    .board{display:flex;justify-content:space-between;align-items:center;margin-top:28px}
    .slot{width:220px;height:300px;background:linear-gradient(180deg,#0b3740,#08323a);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
    .card{width:140px;height:200px;border-radius:12px;background:#0f4860;display:flex;align-items:center;justify-content:center;font-size:44px;font-weight:800;letter-spacing:2px}
    .card.back{background:linear-gradient(135deg,#084452,#06535a)}
    .meta{text-align:center;margin-top:8px;color:var(--muted)}
    .center{display:flex;flex-direction:column;align-items:center;gap:8px}
    .btn {background:var(--accent);border:0;padding:10px 14px;border-radius:10px;color:white;font-weight:700;cursor:pointer}
    .small {background:#0b2930;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .footer{display:flex;justify-content:center;margin-top:18px;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="players">
        <div class="player" id="p0box">
          <div class="pin" id="p0pin">—</div>
          <div class="status" id="p0score">Score: 0</div>
          <div class="status" id="p0deck">Deck: 0</div>
        </div>
        <div class="player" id="p1box">
          <div class="pin" id="p1pin">—</div>
          <div class="status" id="p1score">Score: 0</div>
          <div class="status" id="p1deck">Deck: 0</div>
        </div>
      </div>

      <div style="text-align:center">
        <div class="status" id="roundLabel">Round 1</div>
        <div style="font-size:13px;color:var(--muted)">Best of <span id="bestOfLabel">5</span></div>
      </div>
    </div>

    <div class="board">
      <div class="slot">
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Opponent Played</div>
        <div class="card back" id="opponentCard">--</div>
      </div>

      <div class="center">
        <div style="font-size:13px;color:var(--muted)">Deck</div>
        <div class="card back" id="deckCard">--</div>
        <div class="meta" id="scores">Scores —</div>
      </div>

      <div class="slot">
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Your Played</div>
        <div class="card" id="myCard">--</div>
      </div>
    </div>

    <div class="footer">
      <button id="playBtn" class="btn">Play Top Card</button>
      <button id="nextBtn" class="small">Next Round</button>
      <button id="resetBtn" class="small">Reset Game</button>
    </div>

    <div style="height:18px"></div>
    <div style="text-align:center;color:var(--muted);font-size:13px">Game synced via Firestore — both players see updates live.</div>
  </div>

  <!-- Firebase SDK (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

  <script>
    // ---------- config ----------
    // Option A: parent app exposes config at window.PARENT_FIREBASE_CONFIG
    // Option B: paste your firebase config here directly
    const FIREBASE_CONFIG = window.PARENT_FIREBASE_CONFIG || {
      
  apiKey: "AIzaSyD9Qu-nSOfIE8g5BswnzMnJ0oa2DYJmMqM",
  authDomain: "hi-app-4f799.firebaseapp.com",
  databaseURL:
    "https://hi-app-4f799-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hi-app-4f799",
  storageBucket: "hi-app-4f799.appspot.com",
  messagingSenderId: "376315716692",
  appId: "1:376315716692:web:0146b76463c5190af7f9c1",


    };

    const app = firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();

    // ---------- read players metadata ----------
    const meta = window.GAME_META || (function() {
      // fallback parse query
      const q = {};
      location.search.replace(/^\?/, '').split('&').forEach(kv=>{
        if(!kv) return;
        const [k,v]=kv.split('=');
        q[decodeURIComponent(k)]=decodeURIComponent(v||'');
      });
      return { player0: q.p0, player1: q.p1, convoId: q.convo };
    })();

    const p0 = meta.player0 || 'p0';
    const p1 = meta.player1 || 'p1';
    const convoId = meta.convoId || meta.convo || '';

    document.getElementById('p0pin').textContent = p0;
    document.getElementById('p1pin').textContent = p1;
    document.getElementById('bestOfLabel').textContent = 5;

    if (!convoId) {
      alert('Missing convoId. Launch the game with ?p0=PIN&p1=PIN&convo=CONVOID');
      throw new Error('Missing convoId');
    }

    const gameDocRef = db.collection('conversations').doc(convoId).collection('game').doc('card-duel');

    // ---------- helper: create a fresh deck ----------
    function createDeck() {
      // values 1..13 (ace through king) but we'll use 1..10 to keep short
      const values = [];
      for (let v = 1; v <= 10; v++) {
        values.push(v);
        values.push(v); // duplicate to make a bigger deck
      }
      // shuffle
      for (let i = values.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [values[i], values[j]] = [values[j], values[i]];
      }
      return values;
    }

    // ---------- create game if not exists ----------
    async function ensureGame() {
      const snap = await gameDocRef.get();
      if (!snap.exists) {
        const deck0 = createDeck();
        const deck1 = createDeck();
        await gameDocRef.set({
          players: [p0, p1],
          decks: { p0: deck0, p1: deck1 },
          played: { p0: null, p1: null },
          scores: { p0: 0, p1: 0 },
          round: 1,
          bestOf: 5,
          turn: 'both',
          status: 'in_progress',
          winner: null,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    // ---------- UI helpers ----------
    const opponentCardEl = document.getElementById('opponentCard');
    const myCardEl = document.getElementById('myCard');
    const deckCardEl = document.getElementById('deckCard');
    const scoresEl = document.getElementById('scores');
    const p0scoreEl = document.getElementById('p0score');
    const p1scoreEl = document.getElementById('p1score');
    const p0deckEl = document.getElementById('p0deck');
    const p1deckEl = document.getElementById('p1deck');
    const roundLabel = document.getElementById('roundLabel');

    function showCard(el, value, flipped) {
      if (value == null) {
        el.textContent = '--';
        el.classList.add('back');
        el.classList.remove('card');
      } else {
        el.textContent = String(value);
        el.classList.remove('back');
        el.classList.add('card');
      }
    }

    // ---------- actions ----------
    const playBtn = document.getElementById('playBtn');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');

    playBtn.addEventListener('click', async () => {
      // you play top card from your deck (p1 or p0 depending if you are player1)
      const me = (p0 === window.MY_PIN) || (p0 === window.currentPlayer) ? 'p0' : (p1 === window.MY_PIN || p1 === window.currentPlayer ? 'p1' : null);
      // fallback: if local host testing, assume visitor is p1 if URL contains p1 value
      const amI_p0 = (meta.player0 === window.LOCAL_PLAYER_PIN) || (meta.player0 === window.MY_PIN) || (!window.MY_PIN && navigator.userAgent);
      // simpler: figure out which pin matches location origin? We'll take the meta and compare to a small prompt fallback
      const meKey = (meta.player0 === (window.USER_PIN||window.MY_PIN)) ? 'p0' : 'p1';
      // but game should be started with correct knowledge. We'll try both variations.
      const meActual = (meta.player0 === window.MY_PIN) ? 'p0' : (meta.player1 === window.MY_PIN ? 'p1' : null);

      // For robustness, try to detect by matching the pin stored in window.GAME_META.userPin (optional)
      const myPin = window.MY_PIN || window.USER_PIN || null;
      const myRole = (myPin === p0) ? 'p0' : (myPin === p1 ? 'p1' : null);
      if (!myRole) {
        // If we can't detect, show a small prompt to choose
        const pick = prompt("Are you player0 (enter 0) or player1 (enter 1)? Default 1");
        const role = (pick === '0') ? 'p0' : 'p1';
        await applyPlay(role);
        return;
      }
      await applyPlay(myRole);
    });

    async function applyPlay(role) {
      // atomically read current doc and update
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(gameDocRef);
        if (!snap.exists) throw new Error('Game missing');
        const data = snap.data();
        const decks = data.decks || {};
        const played = data.played || {};
        if (!decks[role] || decks[role].length === 0) {
          // can't play
          alert('No cards left');
          return;
        }
        if (played[role]) {
          // already played this round
          return;
        }
        const card = decks[role].shift(); // take top
        played[role] = card;
        tx.update(gameDocRef, {
          decks,
          played,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    }

    nextBtn.addEventListener('click', async () => {
      // advance to resolution if both played, else no-op
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(gameDocRef);
        if (!snap.exists) return;
        const data = snap.data();
        const played = data.played || {};
        const scores = data.scores || { p0:0, p1:0 };
        let round = data.round || 1;
        const bestOf = data.bestOf || 5;
        if (!played.p0 || !played.p1) {
          alert('Both players must play first');
          return;
        }
        // compare
        if (played.p0 > played.p1) scores.p0++;
        else if (played.p1 > played.p0) scores.p1++;
        // increment round
        round++;
        let winner = null;
        if (scores.p0 > Math.floor(bestOf/2)) winner = 'p0';
        else if (scores.p1 > Math.floor(bestOf/2)) winner = 'p1';
        const newPlayed = { p0: null, p1: null };
        tx.update(gameDocRef, {
          played: newPlayed,
          scores,
          round,
          winner,
          status: winner ? 'finished' : 'in_progress',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    });

    resetBtn.addEventListener('click', async () => {
      const deck0 = createDeck(), deck1 = createDeck();
      await gameDocRef.set({
        players: [p0, p1],
        decks: { p0: deck0, p1: deck1 },
        played: { p0: null, p1: null },
        scores: { p0: 0, p1: 0 },
        round: 1,
        bestOf: 5,
        turn: 'both',
        status: 'in_progress',
        winner: null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    // ---------- realtime listener ----------
    gameDocRef.onSnapshot((snap) => {
      if (!snap.exists) return;
      const data = snap.data();
      const { decks={}, played={}, scores={}, round=1, bestOf=5, status='in_progress', winner=null } = data;
      const p0deck = (decks.p0 || []).length;
      const p1deck = (decks.p1 || []).length;
      p0scoreEl.textContent = 'Score: ' + (scores.p0 || 0);
      p1scoreEl.textContent = 'Score: ' + (scores.p1 || 0);
      p0deckEl.textContent = 'Deck: ' + p0deck;
      p1deckEl.textContent = 'Deck: ' + p1deck;
      roundLabel.textContent = 'Round ' + (round || 1);
      scoresEl.textContent = `Scores ${scores.p0 || 0} — ${scores.p1 || 0}`;
      document.getElementById('bestOfLabel').textContent = bestOf;

      showCard(myCardEl, played.p1 === null && played.p0 === null ? null : ((meta.player0===window.MY_PIN) ? played.p0 : played.p1));
      // we will show opponent card face-down until both played or round resolved
      if (played.p0 !== null && played.p1 !== null) {
        const myRole = (window.MY_PIN === p0) ? 'p0' : (window.MY_PIN === p1 ? 'p1' : null);
        const myPlayed = (myRole === 'p0') ? played.p0 : played.p1;
        const oppPlayed = (myRole === 'p0') ? played.p1 : played.p0;
        showCard(myCardEl, myPlayed);
        showCard(opponentCardEl, oppPlayed);
      } else {
        // show face-downs
        showCard(myCardEl, (meta.player0 === window.MY_PIN) ? played.p0 : played.p1);
        showCard(opponentCardEl, null);
      }

      // show deck middle card count
      deckCardEl.textContent = p0deck + p1deck;
      if (status === 'finished') {
        if (winner) {
          const winnerPin = (winner === 'p0') ? p0 : p1;
          alert('Game finished! Winner: ' + winnerPin);
        } else {
          alert('Game finished: draw');
        }
      }
    });

    // initialize
    (async () => {
      await ensureGame();
      // optionally set a local MY_PIN to avoid prompt (use window.MY_PIN before launching)
      // window.MY_PIN = prompt("Enter your PIN (to identify yourself in the game):");
    })();

  </script>
</body>
</html>